"use strict";(self.webpackChunkjupyterlab_playback=self.webpackChunkjupyterlab_playback||[]).push([[279],{279:(e,t,n)=>{n.r(t),n.d(t,{default:()=>f});var o=n(158),a=n(752),i=n(256),d=n(979),l=n(916);async function s(e="",t={}){const n=l.ServerConnection.makeSettings(),o=d.URLExt.join(n.baseUrl,"jupyterlab-playback",e);let a;try{a=await l.ServerConnection.makeRequest(o,t,n)}catch(e){throw new l.ServerConnection.NetworkError(e)}let i=await a.text();if(i.length>0)try{i=JSON.parse(i)}catch(e){console.log("Not a JSON response body.",a)}if(!a.ok)throw new l.ServerConnection.ResponseError(a,i.message||i);return i}var r=n(813),c=n(24),u=n(195);const m=e=>e?e.map((e=>e.command.join("+"))).join("\n"):"",g=e=>{const t=e.split("\n"),n=t.length||0,o=[];for(let e=0;e<n;e++){const n=t[e];/^\s*#/.test(n)?o.push({command:["TYPE","AUDIO"]}):/^\s*$/.test(n)?o.push({command:["PAUSE500"]}):o.push({command:["TYPE"]})}return{map:o,doc:m(o)}},p=(e,t)=>new Promise((n=>{const o=()=>{const a=e.content.widgets[t].node.getElementsByClassName("lm-Widget lm-Panel jp-Cell-inputWrapper")[0];a?n(a):requestAnimationFrame(o)};o()})),v=e=>c.ViewPlugin.fromClass(class{constructor(t){this.decorations=this.createLineHighlight(t,e)}createLineHighlight(e,t){const n=new u.RangeSetBuilder,o=e.state.doc.line(t),a=c.Decoration.line({class:"highlight-line"});return n.add(o.from,o.from,a),n.finish()}update(t){t.docChanged&&(this.decorations=this.createLineHighlight(t.view,e))}},{decorations:e=>e.decorations}),h=async(e,t,n,o)=>{var a,i;const d=document.getElementById("extension-button");let l=n;if("audio_index"in e[n])for(;l>0&&"audio_index"in e[l-1]&&e[l-1].audio_index===e[l].audio_index;)l-=1;null===(a=null==o?void 0:o.model)||void 0===a||a.setMetadata("cellIndex",t),null===(i=null==o?void 0:o.model)||void 0===i||i.setMetadata("lineIndex",l),d&&(d.innerHTML=" ▶ "),await s("stop",{method:"POST",body:""})},y={id:"jupyterlab-playback:plugin",description:"A JupyterLab extension.",autoStart:!0,requires:[o.INotebookTracker,a.ISettingRegistry],activate:async(e,t,n)=>{console.log("JupyterLab extension jupyterlab-playback is activated!");const a=(await n.load(y.id)).get("metadataEditorWidth").composite;t.widgetAdded.connect((async(e,n)=>{var d,l,y;await n.revealed,await n.sessionContext.ready;const f=document.createElement("button");f.id="extension-button";const w=document.createElement("div");w.appendChild(f),n.toolbar.insertAfter("spacer","button",new i.Widget({node:w}));const b=null===(d=n.model)||void 0===d?void 0:d.getMetadata("mode");b||null===(l=n.model)||void 0===l||l.setMetadata("mode","editor"),b&&"editor"!==b?"player"===b&&(f.innerHTML=" ▶ ",null===(y=n.model)||void 0===y||y.setMetadata("isPlaying",!1),f.onclick=()=>{var e,t;const a=(null===(e=n.model)||void 0===e?void 0:e.getMetadata("isPlaying"))||!1;null===(t=n.model)||void 0===t||t.setMetadata("isPlaying",!a),a||(async e=>{var t,n,a,i,d,l,r;const c=null===(t=e.model)||void 0===t?void 0:t.cells,m=(null===(n=e.model)||void 0===n?void 0:n.getMetadata("cellIndex"))||0,g=(null===(a=e.model)||void 0===a?void 0:a.getMetadata("lineIndex"))||0,p=document.getElementById("extension-button");if(c){p?p.innerHTML="||":console.warn("null button");let t=null;for(let n=m;n<c.length;n++){let a="";const d=c.get(n);if("code"===d.type){const l=d.getMetadata("full_map");for(let r=0;r<(null==l?void 0:l.length);r++){const c=l[r].command,p=l[r].text;if(n===m&&r<g)a+=p,r!=(null==l?void 0:l.length)-1&&(a+="\n"),d.sharedModel.setSource(a);else{if(!e.model.getMetadata("isPlaying"))return void await h(l,n,r,e);if(c.some((e=>e.includes("AUDIO")))){const e=l[r].audio_src;e!==t&&(t=e,await s("audio",{method:"POST",body:JSON.stringify({audio_src:t})}))}for(const t of c){if(t.includes("TYPE")){const t=[...p];r!=(null==l?void 0:l.length)-1&&t.push("\n");for(let o of t)if(a+=o,d.sharedModel.setSource(a),await new Promise((e=>{setTimeout(e,50)})),!e.model.getMetadata("isPlaying"))return void await h(l,n,r,e)}if(t.includes("PAUSE")){const e=t.replace(/\D/g,"");a+="\n",d.sharedModel.setSource(a),await new Promise((t=>{setTimeout(t,e)}))}if(t.includes("SELECT")){const o=t.replace(/\D/g,""),a=null===(i=e.content.widgets[n])||void 0===i?void 0:i.editor,d=v(o);a.editor.dispatch({effects:u.StateEffect.appendConfig.of([d])})}t.includes("EXECUTE")&&o.NotebookActions.runCells(e.content,[e.content.widgets[n]],e.context.sessionContext)}}}}}}p&&(p.innerHTML=" ▶ "),null===(d=e.model)||void 0===d||d.setMetadata("cellIndex",""),null===(l=e.model)||void 0===l||l.setMetadata("lineIndex",""),null===(r=e.model)||void 0===r||r.setMetadata("isPlaying",!1)})(n)}):((async(e,t)=>{var n,o;const a=(null===(n=e.model)||void 0===n?void 0:n.cells.length)||0;for(let n=0;n<a;n++){const a=null===(o=e.model)||void 0===o?void 0:o.cells.get(n);if(a&&"code"==a.type){await e.content.widgets[n].ready;const o=await p(e,n),i=o.getElementsByClassName("jp-Cell-inputArea")[0];i.classList.add("code-editor"),i.style.width=(100-t).toString()+"%";const d=document.createElement("div");d.classList.add("metadata-editor"),d.style.width=t.toString()+"%";const l=a.getMetadata("map")?m(a.getMetadata("map")):(()=>{const{map:e,doc:t}=g(a.sharedModel.source);return a.setMetadata("map",e),t})(),s=u.EditorState.create({doc:l,extensions:[r.basicSetup,(0,c.lineNumbers)(),c.EditorView.updateListener.of((e=>{e.docChanged&&a.setMetadata("map",e.state.doc.toString().split("\n").map((e=>({command:e.split("+")}))))}))]});new c.EditorView({state:s,parent:d}),o.appendChild(d)}}})(n,a),f.innerHTML="Generate an interactive notebook",f.onclick=async()=>{var e,o;f.innerHTML="Generating notebook...";const a=await s("load",{method:"POST",body:JSON.stringify({data:null===(e=null==n?void 0:n.model)||void 0===e?void 0:e.toJSON(),relativePath:null===(o=t.currentWidget)||void 0===o?void 0:o.context.path})});console.log(a),f.innerHTML="Regenerate interactive notebook"})}))}},f=y}}]);